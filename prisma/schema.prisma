// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_PRISMA_URL")
}

model Album {
  id                        String    @id @default(uuid())
  musicBrainzReleaseGroupId String    @unique
  title                     String
  artist                    String
  year                      Int?
  coverUrl                  String?
  votesCount                Int       @default(0)
  featuredAt                DateTime? // When this album became the featured discussion (null = never featured)
  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime  @updatedAt
  
  votes                     Vote[]
  comments                  Comment[]
  
  @@index([votesCount])
  @@index([musicBrainzReleaseGroupId])
  @@index([featuredAt])
}

model Vote {
  id        String   @id @default(uuid())
  albumId   String
  voterHash String   // Hash of cookie ID + IP address
  createdAt DateTime @default(now())
  
  album     Album    @relation(fields: [albumId], references: [id], onDelete: Cascade)
  
  @@unique([albumId, voterHash])
  @@index([albumId])
  @@index([voterHash])
}

// User levels for badges
enum UserLevel {
  ENTHUSIAST
  ADVOCATE
  AMBASSADOR
}

// User roles for access control
enum UserRole {
  USER
  ADMIN
}

// Central user model for all site features
model User {
  id              String        @id @default(uuid())
  email           String        @unique
  displayName     String?       @unique // Username for Trust Your Ears
  fullName        String?                // Full name for profile
  address         String?                // Address (free text)
  country         String?                // Country for display on profile
  level           UserLevel     @default(ENTHUSIAST)
  role            UserRole      @default(USER)
  passwordHash    String?                // Optional - null means magic link only
  createdAt       DateTime      @default(now())
  lastLoginAt     DateTime      @default(now())
  
  comments        Comment[]
  commentLikes    CommentLike[]
  equipment       Equipment[]
  events          UserEvent[]
  
  @@index([email])
  @@index([displayName])
  @@index([level])
}

// User's Lowther equipment collection
model Equipment {
  id        String   @id @default(uuid())
  userId    String
  name      String   // Free text: "TP1 Loudspeaker Pair", "PM6A Drive Unit"
  addedAt   DateTime @default(now())
  fromOrder Boolean  @default(false) // true if auto-added from Shopify order
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
}

// Verification codes for passwordless email auth
model VerificationCode {
  id        String   @id @default(uuid())
  email     String
  code      String   // 6-digit code
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  
  @@index([email, code])
  @@index([expiresAt])
}

// Comments on albums (supports threading via parentId)
model Comment {
  id        String   @id @default(uuid())
  content   String   // The comment text
  albumId   String
  userId    String
  parentId  String?  // If replying to another comment
  likesCount Int     @default(0) // Denormalized count for sorting
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  album     Album    @relation(fields: [albumId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent    Comment? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[] @relation("CommentReplies")
  likes     CommentLike[]
  
  @@index([albumId])
  @@index([userId])
  @@index([parentId])
  @@index([createdAt])
  @@index([likesCount])
}

// Likes on comments
model CommentLike {
  id        String   @id @default(uuid())
  commentId String
  userId    String
  createdAt DateTime @default(now())
  
  comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([commentId, userId]) // One like per user per comment
  @@index([commentId])
  @@index([userId])
}

// Event types for analytics tracking
enum EventType {
  PAGE_VIEW
  CTA_CLICK
  VIDEO_PLAY
  DOWNLOAD_BROCHURE
  DOWNLOAD_PLAN
  FORM_SUBMIT
  PRODUCT_VIEW
  ADD_TO_CART
  BEGIN_CHECKOUT
  TRUST_YOUR_EARS_VOTE
  ENQUIRY_START
  ENQUIRY_SUBMIT
  PRODUCT_REVISIT
  BLOG_DEEP_READ
}

// User event tracking for analytics
model UserEvent {
  id            String    @id @default(uuid())
  userId        String?   // Optional - for logged-in users
  sessionId     String    // For anonymous tracking
  eventType     EventType
  eventData     Json?     // Additional data (product handle, collection, etc.)
  path          String    // Page URL path
  referrer      String?   // Where they came from
  userAgent     String?   // Browser/device info
  timestamp     DateTime  @default(now())
  
  user          User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([sessionId])
  @@index([eventType])
  @@index([timestamp])
  @@index([path])
}
